<!DOCTYPE html>

<html>
<head>
<title>HTML5 Ajax big file--UPLOAD</title>


<script type="text/javascript">

/*
//版本1，由于浏览器js reflow特性，所以进度条无法循环更新
function sendfile() {
    const LENGTH = 2*1024*1024; //2M
    var sta = 0;
    var end = sta + LENGTH;
    var blob = null;
    var fd = null;
    
   
    var xhr = null;
    //上传过程中触发

    

    var mov = document.getElementsByName('mov')[0].files[0];
    //console.log(mov);return;
    
    var totalsize = mov.size;
    
    while(sta < totalsize) {
        blob = mov.slice(sta,end);
        console.log(blob);
        fd = new FormData();
        fd.append('part',blob);
        
        
        xhr = new XMLHttpRequest();
        xhr.open('POST', 'html5upload_big.php', false);  //如果要用异步，需要给传送文件排队命名，否则后台无法知道谁先谁后
        
        var percent = 100*(end/totalsize);
        if (percent >= 100) {
            percent = 100;
        } else {
            percent = parseInt(percent);
        }
        
        console.log(end, totalsize);
        document.getElementById('bar').style.width = percent+'%';
        document.getElementById('bar').innerHTML=parseInt(percent) + '%';
        xhr.send(fd);
        
        sta = end;
        end = sta + LENGTH;
    }
    
}
*/

/*
版本2 使用定时器，调用sendfile，使进度条得到更新

用到的API
file-->继承自-->Blob
Blob有slice方法，可以截取二进制对象的一部分。

思路：
截取10M，上传
判断文件有没有截取完毕

用定时器，不断调用上传方法
*/


var xhr = new XMLHttpRequest();
var clock = null;

function fire() {
    clock = window.setInterval(sendfile,1000);
}

//闭包计数器——匿名函数
var sendfile = (function() {
    const LENGTH = 1*1024*1024; //每次切10M
    var sta = 0;
    var end = sta +LENGTH;
    var sending = false;    //标志正在上传中
    
    var blob = null;
    var fd = null;
    
    
    
    //百分比
    var percent = 0;
    
    return (function () {       //有return 才能执行
        if (sending == true) {      //检查前面的还没传完
            return;
        }
        
        var mov = document.getElementsByName('mov')[0].files[0];
        
        //如果sta->mov.size，代表结束
        if (sta>mov.size) {
            clearInterval(clock);   //上传结束要清理clock
            return
        }

        blob = mov.slice(sta,end);
        console.log(blob);
        fd = new FormData();
        fd.append('part',blob);
        
        up(fd); //待用上传函数up
        
        sta = end;
        end = sta + LENGTH;
        sending = false;//上传完毕
        
        percent = 100*end/mov.size;
        if(percent>100) {
            percent =100;
        }
        document.getElementById('bar').style.width=percent + '%';
        document.getElementById('bar').innerHTML=parseInt(percent) + '%';
        
    });
})(); //括号代表立即执行。

function up(fd) {
    xhr.open('POST', 'html5upload_big.php', false);
    xhr.send(fd);
}







</script>
<style type="text/css">
#progress {
    width:500px;
    height:20px;
    border:1px solid green;
}
#bar {
    width: 0%;
    height:100%;
    background:green;
}

</style>
</head>
<body>
<h1>Ajax HTML5 大文件切割上传</h1>
<div id="progress">
    <div id="bar"></div>
</div>
<input type="file" name="mov" onchange="fire();" />


</body>

</html>